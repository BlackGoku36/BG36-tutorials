<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="../../../doc.css">
    <link rel="stylesheet" href="../../../atom-one-dark.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>BG36-Tutorials | TUT-1</title>
</head>
<body class="purple-grey">
    <div id="sidebar" class="sidebar">
        <script src="../sidebar.js"></script>
    </div>
    <div id="main">
        <script src="../../../main1.js"></script>
        <script>main("Save/Load Part-1");</script>
        <p>First we will implement basics of file reading and writing for krom in-game. At the end of this part you should be able to save/load json from <code>Bundled</code> folder, when in-game.</p>
<p>We will first set-up the saving mechanism for hard-coded value.</p>
<ol>
<li>Create a Haxe trait <code>SaveLoadMechanism</code>, we will use this for handling our save and load mechanism.</li>
</ol>
<!-- tabs:start -->
<h4 id="saveloadmechanismhx"><strong>SaveLoadMechanism.hx</strong></h4>
<pre><code class="haxe language-haxe">package arm;

class SaveLoadMechanism extends iron.Trait {
    public function new() {
        super();

        notifyOnInit(function() {
            // Only compile the code for krom platform
            #if kha_krom
            // Set json structure with text as 'hello World!'
            var saveData = { text: 'Hello World!' };
            // Converts above structure to json string.
            var saveDataJSON = haxe.Json.stringify(saveData);
            // Get Krom`s location path and add path for save_game.json.
            var path = Krom.getFilesLocation() + "/save_game.json";
            // Write json string to bytes.
            var bytes = haxe.io.Bytes.ofString(saveDataJSON);
            // Save to file from path specified above with data from bytes.
            Krom.fileSaveBytes(path, bytes.getData());
            #end
        });

    }
}
</code></pre>
<hr />
<p><details>
    <summary>Code Explanation</summary></p>
<ol>
<li><code>#if some_condition</code> is called <a href="https://en.wikipedia.org/wiki/Conditional_compilation">Conditional Compiling</a> expression, here, our code will only be compiled to Krom platform.</li>
<li>We define structure and convert the structure into json.</li>
<li>We get Krom's file location (during playing from armory, krom's file location is <code>root_folder/build_file/debug/krom/save_game.json</code>) and append our <code>save_game.json</code> to the path.</li>
<li>Convert our stringy json to bytes.</li>
<li>Save data from bytes to path specified.
</details></li>
</ol>
<hr />
<!-- tabs:end -->
<p>Now, if you play the game and go over to <code>root_folder/build_file/debug/krom/</code> you should find <code>save_game.json</code> and on opening it should read <code>{"text":"Hello World!"}</code>, if you do, then Congratulation! You did it!</p>
<p>Let save <code>save_game.json</code> to proper place and add some keyboard input code to handle saving manually instead of saving when the game initiate.</p>
<!-- tabs:start -->
<h4 id="saveloadmechanismhx-1"><strong>SaveLoadMechanism.hx</strong></h4>
<pre><code class="haxe language-haxe">package arm;
import iron.system.Input;

class SaveLoadMechanism extends iron.Trait {
    //Get keyboard's input.
    var kb = Input.getKeyboard();

    public function new() {
        super();

        notifyOnUpdate(function() {
            if(kb.started("f")){
                save();
            }
        });
    }

    public function save(){
        ~
        var saveDataJSON = haxe.Json.stringify(saveData);
        //Move out of 3 dirs
        var path = Krom.getFilesLocation() + "/../../../" + "/Bundled/save_game.json";
        var bytes = haxe.io.Bytes.ofString(saveDataJSON);
        ~
        #end
    }
}
</code></pre>
<hr />
<p><details>
    <summary>Code Explanation</summary></p>
<ol>
<li>On every frame, check if key <code>f</code> is pressed, than call <code>save()</code></li>
<li>We add <code>/../../../</code> before path to move out of three directory.
</details></li>
</ol>
<hr />
<!-- tabs:end -->
<p><img src="../../../docassets/save_load_4.png" alt="savejsonbundled" width="70%" height="70%" /></p>
<div class="alert alert-warning" role="alert">
  Don't forget to create Bundled folder in your root directory!
</div>
<p>We will now add reading functionality, we will read <code>save_game.json</code> from <code>Bundled</code> folder and print <code>text</code> value in debug console.</p>
<p>Now let get to code:</p>
<!-- tabs:start -->
<h4 id="saveloadmechanism"><strong>SaveLoadMechanism</strong></h4>
<pre><code class="haxe language-haxe">package arm;

import iron.system.Input;
import iron.data.Data;

class SaveLoadMechanism extends iron.Trait {

    var kb = Input.getKeyboard();
    var saveFile = "save_game.json";
    public function new() {
        super();

        notifyOnUpdate(function() {
            if(kb.started("f")){
                save();
            }else if(kb.started("g")){
                load();
            }
        });
    }

    public function save() { ~ }

    public function load(){
        //Get Blob, from `Bundled`
        Data.getBlob(saveFile, function(bytes:kha.Blob) {
            //Converts bytes to string.
            var jsonString = bytes.toString();
            //Parse value from stringy json.
            var json = haxe.Json.parse(jsonString);
            trace(json.text);
        });
    }
}
</code></pre>
<hr />
<p><details>
    <summary>Code Explanation</summary></p>
<ol>
<li>Check if <code>f</code>, <code>g</code> is pressed and then call <code>save()</code>, <code>load()</code> respectively.</li>
<li>Load blob from path specified.</li>
<li>Convert the file to string and then parse json from it.
</details></li>
</ol>
<hr />
<!-- tabs:end -->
<p>Hit <code>Play</code>, try pressing <code>f</code> and then <code>g</code>, <code>Hello World!</code> should appear in debug console, if it do than that means saving and loading work perfectly!</p>
<p><img src="../../../docassets/save_load_6.png" alt="printdebugconsole" title=":size=700" /></p>
<p>And that is for today! In next part we will make it save cube's Location and Rotation.</p>
        </div>
    </div>
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            <li class="page-item">
                <a class="page-link a" href="Save_Load_Mechanism.html" tabindex="-1" aria-disabled="true">Previous</a>
            </li>
            <li class="page-item"><a class="page-link a " href="Save_Load_Mechanism.html">1</a></li>
            <li class="page-item"><a class="page-link active" href="Save_Load_1.html">2</a></li>
            <li class="page-item"><a class="page-link a" href="Save_Load_2.html">3</a></li>
            <li class="page-item"><a class="page-link a" href="Save_Load_3.html">4</a></li>
            <li class="page-item">
                <a class="page-link a" href="Save_Load_2.html">Next</a>
            </li>
        </ul>
    </nav>
    <script src="../../../main2.js"></script>
    <script>create("../../../")</script>
</body>
</html>